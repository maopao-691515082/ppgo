import (
    "fiber";
)

class ClientMain
{
    conn fiber.TCPConn;

    func init(conn fiber.TCPConn)
    {
        this.conn = conn;
    }

    public func run()
    {
        var buf []byte;
        buf.resize(1024);
        while (true)
        {
            var n = this.conn.read(buf);
            if(n == 0)
            {
                return;
            }
            this.conn.write(buf, len = n, timeout = 1.0);
        }
    }
}

class EchoSvrMain
{
    public func run()
    {
        var listener = fiber.TCPListener(9999);
        println("server start");
        while (true)
        {
            var conn, exc, tb = listener.accept();
            if (exc != nil)
            {
                println("accept failed: [%s] [%s]".(exc, tb));
                continue;
            }
            fiber.new(ClientMain(conn));
        }
    }
}

public func main()
{
    fiber.run(EchoSvrMain());
}
